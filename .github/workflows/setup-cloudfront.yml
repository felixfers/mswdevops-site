name: ðŸ”’ Setup CloudFront + HTTPS

on: workflow_dispatch

env:
  S3_BUCKET: 'www.mswdevops.com'

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ” Configure AWS
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: ðŸ“‹ Check current CloudFront distributions
      run: |
        echo "=== VERIFICANDO CLOUDFRONT EXISTENTE ==="
        
        # Verificar si ya existe distribuciÃ³n para este bucket
        EXISTING_DIST=$(aws cloudfront list-distributions \
          --query "DistributionList.Items[?contains(Comment, '${{ env.S3_BUCKET }}') || \
                   Origins.Items[?DomainName=='${{ env.S3_BUCKET }}.s3.amazonaws.com'].Id" \
          --output text)
        
        if [ -n "$EXISTING_DIST" ]; then
          echo "âœ… Ya existe distribuciÃ³n CloudFront: $EXISTING_DIST"
          echo "distribution_id=$EXISTING_DIST" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "ðŸ“¦ No existe distribuciÃ³n. Creando nueva..."
        fi
        
    - name: ðŸ› ï¸ Create CloudFront Distribution (if needed)
      id: create_cf
      if: steps.check_cf.outcome != 'success'
      run: |
        echo "=== CREANDO NUEVA DISTRIBUCIÃ“N CLOUDFRONT ==="
        
        # Paso 1: Crear Origin Access Identity (OAI)
        echo "1. Creando Origin Access Identity..."
        OAI_RESPONSE=$(aws cloudfront create-cloud-front-origin-access-identity \
          --cloud-front-origin-access-identity-config \
            CallerReference="cf-oai-$(date +%s)" \
            Comment="OAI for ${{ env.S3_BUCKET }}")
        
        OAI_ID=$(echo $OAI_RESPONSE | jq -r '.CloudFrontOriginAccessIdentity.Id')
        echo "OAI ID: $OAI_ID"
        
        # Paso 2: Crear configuraciÃ³n JSON para CloudFront
        echo "2. Preparando configuraciÃ³n CloudFront..."
        
        cat > cloudfront-config.json << EOF
        {
          "CallerReference": "cf-$(date +%s)",
          "Comment": "CloudFront for ${{ env.S3_BUCKET }}",
          "Origins": {
            "Quantity": 1,
            "Items": [
              {
                "Id": "S3-${{ env.S3_BUCKET }}",
                "DomainName": "${{ env.S3_BUCKET }}.s3.amazonaws.com",
                "OriginPath": "",
                "CustomHeaders": {
                  "Quantity": 0
                },
                "S3OriginConfig": {
                  "OriginAccessIdentity": "origin-access-identity/cloudfront/$OAI_ID"
                }
              }
            ]
          },
          "DefaultCacheBehavior": {
            "TargetOriginId": "S3-${{ env.S3_BUCKET }}",
            "ViewerProtocolPolicy": "redirect-to-https",
            "TrustedSigners": {
              "Enabled": false,
              "Quantity": 0
            },
            "ForwardedValues": {
              "QueryString": false,
              "Cookies": {
                "Forward": "none"
              },
              "Headers": {
                "Quantity": 0
              },
              "QueryStringCacheKeys": {
                "Quantity": 0
              }
            },
            "MinTTL": 0,
            "DefaultTTL": 86400,
            "MaxTTL": 31536000,
            "Compress": true,
            "LambdaFunctionAssociations": {
              "Quantity": 0
            },
            "FieldLevelEncryptionId": ""
          },
          "CacheBehaviors": {
            "Quantity": 0
          },
          "CustomErrorResponses": {
            "Quantity": 0
          },
          "Comment": "CDN for static site ${{ env.S3_BUCKET }}",
          "Logging": {
            "Enabled": false,
            "IncludeCookies": false,
            "Bucket": "",
            "Prefix": ""
          },
          "PriceClass": "PriceClass_100",
          "Enabled": true,
          "ViewerCertificate": {
            "CloudFrontDefaultCertificate": true,
            "MinimumProtocolVersion": "TLSv1.2_2021",
            "SSLSupportMethod": "sni-only"
          },
          "Restrictions": {
            "GeoRestriction": {
              "RestrictionType": "none",
              "Quantity": 0
            }
          },
          "WebACLId": "",
          "HttpVersion": "http2",
          "IsIPV6Enabled": true
        }
        EOF
        
        # Paso 3: Crear la distribuciÃ³n CloudFront
        echo "3. Creando distribuciÃ³n CloudFront (esto puede tardar 1-2 minutos)..."
        CF_RESPONSE=$(aws cloudfront create-distribution \
          --distribution-config file://cloudfront-config.json)
        
        DISTRIBUTION_ID=$(echo $CF_RESPONSE | jq -r '.Distribution.Id')
        DISTRIBUTION_DOMAIN=$(echo $CF_RESPONSE | jq -r '.Distribution.DomainName')
        
        echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
        echo "distribution_domain=$DISTRIBUTION_DOMAIN" >> $GITHUB_OUTPUT
        
        echo "âœ… DistribuciÃ³n creada: $DISTRIBUTION_ID"
        echo "ðŸŒ Domain: $DISTRIBUTION_DOMAIN"
        
    - name: ðŸ”„ Update S3 bucket policy for CloudFront
      run: |
        echo "=== ACTUALIZANDO POLÃTICA DEL BUCKET ==="
        
        # Obtener OAI creado
        OAI_ID=$(aws cloudfront list-cloud-front-origin-access-identities \
          --query "CloudFrontOriginAccessIdentityList.Items[?contains(Comment, '${{ env.S3_BUCKET }}')].Id" \
          --output text)
        
        if [ -n "$OAI_ID" ]; then
          echo "Actualizando polÃ­tica para OAI: $OAI_ID"
          
          # Crear nueva polÃ­tica que solo permite CloudFront
          cat > new-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "CloudFrontAccess",
                "Effect": "Allow",
                "Principal": {
                  "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity $OAI_ID"
                },
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::${{ env.S3_BUCKET }}/*"
              }
            ]
          }
          EOF
          
          # Aplicar nueva polÃ­tica
          aws s3api put-bucket-policy \
            --bucket ${{ env.S3_BUCKET }} \
            --policy file://new-policy.json
            
          echo "âœ… PolÃ­tica actualizada: Solo CloudFront puede acceder al bucket"
        else
          echo "âš ï¸ No se encontrÃ³ OAI, la polÃ­tica actual podrÃ­a seguir funcionando"
        fi
        
    - name: ðŸŒ Show CloudFront URL
      run: |
        echo ""
        echo "========================================"
        echo "ðŸŽ‰ Â¡CLOUDFRONT CONFIGURADO!"
        echo "========================================"
        echo ""
        echo "âœ… HTTPS/SSL: ACTIVADO (gratis)"
        echo "âœ… CDN Global: ACTIVADO"
        echo "âœ… Cache: ACTIVADO"
        echo "âœ… HTTP/2: ACTIVADO"
        echo ""
        
        if [ -n "${{ steps.create_cf.outputs.distribution_domain }}" ]; then
          echo "ðŸŒ Tu sitio con HTTPS estÃ¡ en:"
          echo "https://${{ steps.create_cf.outputs.distribution_domain }}"
          echo ""
          echo "ðŸ”— URL CloudFront:"
          echo "https://${{ steps.create_cf.outputs.distribution_domain }}"
          echo ""
          echo "âš ï¸ La distribuciÃ³n puede tardar 10-15 minutos en estar completamente activa"
          echo "âš ï¸ Mientras tanto, sigue usando la URL de S3"
        else
          echo "âš ï¸ No se pudo obtener el dominio CloudFront"
          echo "Revisa en AWS Console â†’ CloudFront"
        fi
        
        echo ""
        echo "ðŸ“Š Para ver en AWS Console:"
        echo "https://console.aws.amazon.com/cloudfront/home"
        echo "========================================"
        
    - name: â³ Wait for CloudFront deployment
      run: |
        echo "Esperando 30 segundos para que CloudFront inicie el despliegue..."
        sleep 30
        echo "âœ… CloudFront estÃ¡ desplegÃ¡ndose en segundo plano"
        echo "El proceso completo puede tardar 10-15 minutos"