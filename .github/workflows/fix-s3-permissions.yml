name: ðŸ”“ Fix S3 Bucket Permissions

on: workflow_dispatch

env:
  S3_BUCKET: 'www.mswdevops.com'

jobs:
  fix-permissions:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ” Configure AWS
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: ðŸ“ Crear polÃ­tica de bucket para CloudFront
      run: |
        echo "Creando polÃ­tica para bucket: ${{ env.S3_BUCKET }}"
        
        cat > bucket-policy.json << EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowCloudFrontAccess",
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudfront.amazonaws.com"
              },
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::${{ env.S3_BUCKET }}/*",
              "Condition": {
                "StringEquals": {
                  "AWS:SourceArn": "arn:aws:cloudfront::$(aws sts get-caller-identity --query Account --output text):distribution/E2NGPSUG1KHM6E"
                }
              }
            },
            {
              "Sid": "PublicReadForGetBucketObjects",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::${{ env.S3_BUCKET }}/*"
            }
          ]
        }
        EOF
        
        echo "PolÃ­tica creada:"
        cat bucket-policy.json
    
    - name: ðŸ› ï¸ Aplicar polÃ­tica al bucket
      run: |
        echo "Aplicando polÃ­tica a bucket S3..."
        
        # Aplicar polÃ­tica
        aws s3api put-bucket-policy \
          --bucket "${{ env.S3_BUCKET }}" \
          --policy file://bucket-policy.json
        
        echo "âœ… PolÃ­tica aplicada"
        
        # Habilitar website hosting
        aws s3 website "s3://${{ env.S3_BUCKET }}" \
          --index-document index.html \
          --error-document error.html 2>/dev/null || echo "Website config already exists"
        
        echo "âœ… Website hosting habilitado"
    
    - name: ðŸ“‚ Verificar contenido del bucket
      run: |
        echo "Contenido actual del bucket:"
        aws s3 ls "s3://${{ env.S3_BUCKET }}" --recursive || echo "Bucket vacÃ­o o sin acceso"
        
        echo ""
        echo "Si el bucket estÃ¡ vacÃ­o, ejecuta 'Deploy to S3' despuÃ©s de este fix"