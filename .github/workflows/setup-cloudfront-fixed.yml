name: üîí Setup CloudFront + HTTPS (FIXED)

on: workflow_dispatch

env:
  S3_BUCKET: 'www.mswdevops.com'

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîê Configure AWS
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: üìã Step 1: Check if CloudFront already exists
      id: check_cf
      run: |
        echo "=== BUSCANDO CLOUDFRONT EXISTENTE ==="
        
        # Listar TODAS las distribuciones primero
        echo "Listando todas las distribuciones CloudFront..."
        ALL_DISTRIBUTIONS=$(aws cloudfront list-distributions)
        echo "$ALL_DISTRIBUTIONS" | jq -r '.DistributionList.Items[] | "\(.Id) - \(.DomainName) - \(.Comment // "no-comment")"' 2>/dev/null || echo "No se puede parsear JSON"
        
        # Buscar manualmente por bucket name en comment o origins
        echo ""
        echo "Buscando distribuci√≥n para bucket: ${{ env.S3_BUCKET }}"
        
        # M√©todo 1: Buscar en comments
        DIST_ID=$(echo "$ALL_DISTRIBUTIONS" | jq -r '.DistributionList.Items[] | select(.Comment != null) | select(.Comment | contains("www.mswdevops.com")) | .Id' 2>/dev/null || echo "")
        
        # M√©todo 2: Buscar en origins (si no encontr√≥ por comment)
        if [ -z "$DIST_ID" ]; then
          DIST_ID=$(echo "$ALL_DISTRIBUTIONS" | jq -r '.DistributionList.Items[] | select(.Origins.Items[].DomainName == "www.mswdevops.com.s3.amazonaws.com") | .Id' 2>/dev/null || echo "")
        fi
        
        if [ -n "$DIST_ID" ]; then
          echo "‚úÖ Ya existe distribuci√≥n CloudFront: $DIST_ID"
          echo "distribution_id=$DIST_ID" >> $GITHUB_OUTPUT
          
          # Obtener dominio
          DIST_DOMAIN=$(echo "$ALL_DISTRIBUTIONS" | jq -r --arg id "$DIST_ID" '.DistributionList.Items[] | select(.Id == $id) | .DomainName' 2>/dev/null || echo "")
          if [ -n "$DIST_DOMAIN" ]; then
            echo "distribution_domain=$DIST_DOMAIN" >> $GITHUB_OUTPUT
          fi
        else
          echo "üì¶ No existe distribuci√≥n para este bucket. Crearemos una nueva."
        fi
        
    - name: üõ†Ô∏è Step 2: Create CloudFront if not exists
      id: create_cf
      if: steps.check_cf.outputs.distribution_id == ''
      run: |
        echo "=== CREANDO NUEVA DISTRIBUCI√ìN CLOUDFRONT ==="
        
        # Primero verificar que tenemos permisos
        echo "1. Verificando permisos CloudFront..."
        if ! aws cloudfront list-distributions --max-items 1 > /dev/null 2>&1; then
          echo "‚ùå ERROR: No tienes permisos CloudFront"
          echo "   Ve a AWS IAM ‚Üí Users ‚Üí github-actions-deploy"
          echo "   Agrega pol√≠tica: CloudFrontFullAccess"
          exit 1
        fi
        echo "‚úÖ Permisos OK"
        
        echo "2. Creando Origin Access Identity (OAI)..."
        # Crear OAI simple
        OAI_CONFIG='{
          "CloudFrontOriginAccessIdentityConfig": {
            "CallerReference": "'$(date +%s)'",
            "Comment": "OAI for '${{ env.S3_BUCKET }}'"
          }
        }'
        
        echo "$OAI_CONFIG" > oai-config.json
        OAI_RESPONSE=$(aws cloudfront create-cloud-front-origin-access-identity \
          --cloud-front-origin-access-identity-config file://oai-config.json 2>&1)
        
        if echo "$OAI_RESPONSE" | grep -q "AccessDenied"; then
          echo "‚ùå ERROR: Sin permisos para crear OAI"
          exit 1
        fi
        
        OAI_ID=$(echo "$OAI_RESPONSE" | jq -r '.CloudFrontOriginAccessIdentity.Id' 2>/dev/null || echo "")
        
        if [ -z "$OAI_ID" ]; then
          echo "‚ö†Ô∏è No se pudo crear OAI, usando configuraci√≥n sin OAI"
          OAI_REF=""
        else
          echo "‚úÖ OAI creado: $OAI_ID"
          OAI_REF="origin-access-identity/cloudfront/$OAI_ID"
        fi
        
        echo "3. Creando configuraci√≥n CloudFront..."
        # Configuraci√≥n SIMPLIFICADA que S√ç funciona
        cat > cf-config.json << 'EOF'
        {
          "CallerReference": "cf-$(date +%s)",
          "Comment": "CloudFront for www.mswdevops.com",
          "Origins": {
            "Quantity": 1,
            "Items": [
              {
                "Id": "S3-www.mswdevops.com",
                "DomainName": "www.mswdevops.com.s3.amazonaws.com",
                "S3OriginConfig": {
                  "OriginAccessIdentity": ""
                }
              }
            ]
          },
          "DefaultCacheBehavior": {
            "TargetOriginId": "S3-www.mswdevops.com",
            "ViewerProtocolPolicy": "redirect-to-https",
            "TrustedSigners": {
              "Enabled": false,
              "Quantity": 0
            },
            "ForwardedValues": {
              "QueryString": false,
              "Cookies": {
                "Forward": "none"
              }
            },
            "MinTTL": 0,
            "DefaultTTL": 86400,
            "MaxTTL": 31536000
          },
          "Enabled": true,
          "Comment": "CDN for static site www.mswdevops.com",
          "PriceClass": "PriceClass_100",
          "HttpVersion": "http2",
          "IsIPV6Enabled": true
        }
        EOF
        
        # Insertar OAI si se cre√≥
        if [ -n "$OAI_REF" ]; then
          jq --arg oai "$OAI_REF" '.Origins.Items[0].S3OriginConfig.OriginAccessIdentity = $oai' cf-config.json > cf-config-with-oai.json
          mv cf-config-with-oai.json cf-config.json
        fi
        
        echo "4. Creando distribuci√≥n CloudFront..."
        CF_RESPONSE=$(aws cloudfront create-distribution \
          --distribution-config file://cf-config.json 2>&1)
        
        if echo "$CF_RESPONSE" | grep -q "AccessDenied"; then
          echo "‚ùå ERROR: Sin permisos para crear distribuci√≥n CloudFront"
          echo "Respuesta completa:"
          echo "$CF_RESPONSE"
          exit 1
        fi
        
        DISTRIBUTION_ID=$(echo "$CF_RESPONSE" | jq -r '.Distribution.Id' 2>/dev/null || echo "")
        DISTRIBUTION_DOMAIN=$(echo "$CF_RESPONSE" | jq -r '.Distribution.DomainName' 2>/dev/null || echo "")
        
        if [ -z "$DISTRIBUTION_ID" ]; then
          echo "‚ùå ERROR: No se pudo crear distribuci√≥n"
          echo "Respuesta completa:"
          echo "$CF_RESPONSE"
          exit 1
        fi
        
        echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
        echo "distribution_domain=$DISTRIBUTION_DOMAIN" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Distribuci√≥n creada exitosamente!"
        echo "   ID: $DISTRIBUTION_ID"
        echo "   Domain: $DISTRIBUTION_DOMAIN"
        
    - name: üåê Step 3: Show results
      run: |
        echo ""
        echo "========================================"
        echo "üéâ RESULTADOS CLOUDFRONT"
        echo "========================================"
        
        if [ -n "${{ steps.check_cf.outputs.distribution_id }}" ]; then
          echo "‚úÖ Usando distribuci√≥n EXISTENTE:"
          echo "   ID: ${{ steps.check_cf.outputs.distribution_id }}"
          echo "   Domain: ${{ steps.check_cf.outputs.distribution_domain }}"
          CF_DOMAIN="${{ steps.check_cf.outputs.distribution_domain }}"
        elif [ -n "${{ steps.create_cf.outputs.distribution_id }}" ]; then
          echo "‚úÖ NUEVA distribuci√≥n creada:"
          echo "   ID: ${{ steps.create_cf.outputs.distribution_id }}"
          echo "   Domain: ${{ steps.create_cf.outputs.distribution_domain }}"
          CF_DOMAIN="${{ steps.create_cf.outputs.distribution_domain }}"
        else
          echo "‚ùå No se pudo obtener informaci√≥n de CloudFront"
          CF_DOMAIN=""
        fi
        
        if [ -n "$CF_DOMAIN" ]; then
          echo ""
          echo "üîó Tu sitio con HTTPS est√° en:"
          echo "   https://$CF_DOMAIN"
          echo ""
          echo "üåç Compara con tu URL S3 original:"
          echo "   HTTP: http://www.mswdevops.com.s3-website-us-east-1.amazonaws.com"
          echo "   HTTPS: https://$CF_DOMAIN"
          echo ""
          echo "‚è±Ô∏è Si es nueva distribuci√≥n, puede tardar 15-30 minutos en estar activa"
        fi
        
        echo ""
        echo "üìä Para ver en AWS Console:"
        echo "   https://console.aws.amazon.com/cloudfront/v3/home"
        echo "========================================"