name: üîê Setup CloudFront (HTTPS)

on: workflow_dispatch

env:
  S3_BUCKET: 'www.mswdevops.com'

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîê Configure AWS
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: üîç Buscar CloudFront existente (VERSI√ìN SIMPLE)
      id: check_cf
      run: |
        echo "Buscando CloudFront para: ${{ env.S3_BUCKET }}"
        
        # M√©todo SEGURO: Listar todas y filtrar con jq
        ALL_CF=$(aws cloudfront list-distributions --output json)
        
        # Guardar para debug
        echo "=== DEBUG: Respuesta completa (primeras 500 chars) ==="
        echo "$ALL_CF" | head -c 500
        echo ""
        echo "=========================================="
        
        # Buscar distribuci√≥n que apunte a nuestro bucket S3
        # Formato del dominio: www.mswdevops.com.s3.amazonaws.com
        BUCKET_DOMAIN="${{ env.S3_BUCKET }}.s3.amazonaws.com"
        
        echo "Buscando dominio: $BUCKET_DOMAIN"
        
        # Usar jq para buscar
        CF_ID=$(echo "$ALL_CF" | jq -r --arg domain "$BUCKET_DOMAIN" '
          .DistributionList.Items[] |
          select(.Origins.Items[].DomainName == $domain) |
          .Id' 2>/dev/null || echo "NO_ENCONTRADO")
        
        echo "Resultado b√∫squeda: $CF_ID"
        
        if [ "$CF_ID" != "NO_ENCONTRADO" ] && [ -n "$CF_ID" ]; then
          echo "‚úÖ CloudFront EXISTE: $CF_ID"
          
          # Obtener dominio tambi√©n
          CF_DOMAIN=$(echo "$ALL_CF" | jq -r --arg id "$CF_ID" '
            .DistributionList.Items[] | 
            select(.Id == $id) | 
            .DomainName')
          
          echo "Dominio CloudFront: $CF_DOMAIN"
          
          echo "distribution_id=$CF_ID" >> $GITHUB_OUTPUT
          echo "distribution_domain=$CF_DOMAIN" >> $GITHUB_OUTPUT
          echo "cf_exists=true" >> $GITHUB_OUTPUT
        else
          echo "üì¶ NO existe CloudFront para este bucket"
          echo "cf_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: üÜï Crear CloudFront (si no existe)
      if: steps.check_cf.outputs.cf_exists == 'false'
      id: create_cf
      run: |
        echo "=== CREANDO NUEVO CLOUDFRONT ==="
        
        # Configuraci√≥n SIMPLIFICADA que SI funciona
        cat > cf-config.json << EOF
        {
          "CallerReference": "cf-$(date +%s)",
          "Origins": {
            "Quantity": 1,
            "Items": [
              {
                "Id": "S3-${{ env.S3_BUCKET }}",
                "DomainName": "${{ env.S3_BUCKET }}.s3.amazonaws.com",
                "S3OriginConfig": {
                  "OriginAccessIdentity": ""
                }
              }
            ]
          },
          "DefaultCacheBehavior": {
            "TargetOriginId": "S3-${{ env.S3_BUCKET }}",
            "ViewerProtocolPolicy": "redirect-to-https",
            "TrustedSigners": {
              "Enabled": false,
              "Quantity": 0
            },
            "ForwardedValues": {
              "QueryString": false,
              "Cookies": {
                "Forward": "none"
              }
            },
            "MinTTL": 0,
            "DefaultTTL": 86400,
            "MaxTTL": 31536000,
            "Compress": true,
            "AllowedMethods": {
              "Quantity": 2,
              "Items": ["GET", "HEAD"],
              "CachedMethods": {
                "Quantity": 2,
                "Items": ["GET", "HEAD"]
              }
            }
          },
          "Comment": "HTTPS for ${{ env.S3_BUCKET }}",
          "Enabled": true,
          "DefaultRootObject": "index.html",
          "PriceClass": "PriceClass_100",
          "HttpVersion": "http2",
          "IsIPV6Enabled": true
        }
        EOF
        
        echo "=== Configuraci√≥n creada ==="
        cat cf-config.json
        
        echo ""
        echo "=== Creando distribuci√≥n CloudFront ==="
        
        # Crear distribuci√≥n
        CF_RESPONSE=$(aws cloudfront create-distribution --distribution-config file://cf-config.json 2>&1)
        
        # Verificar si hubo error
        if echo "$CF_RESPONSE" | grep -q "error\|Error\|ERROR"; then
          echo "‚ùå ERROR al crear CloudFront:"
          echo "$CF_RESPONSE"
          exit 1
        fi
        
        # Extraer ID y dominio
        CF_ID=$(echo "$CF_RESPONSE" | jq -r '.Distribution.Id' 2>/dev/null || echo "ERROR")
        CF_DOMAIN=$(echo "$CF_RESPONSE" | jq -r '.Distribution.DomainName' 2>/dev/null || echo "ERROR")
        
        if [ "$CF_ID" = "ERROR" ]; then
          echo "‚ùå No se pudo extraer ID de CloudFront"
          echo "Respuesta completa:"
          echo "$CF_RESPONSE"
          exit 1
        fi
        
        echo "distribution_id=$CF_ID" >> $GITHUB_OUTPUT
        echo "distribution_domain=$CF_DOMAIN" >> $GITHUB_OUTPUT
        
        echo "‚úÖ CloudFront CREADO EXITOSAMENTE"
        echo "   ID: $CF_ID"
        echo "   Dominio: $CF_DOMAIN"
    
    - name: üìä Mostrar resultado FINAL
      run: |
        echo ""
        echo "========================================"
        echo "üéâ CONFIGURACI√ìN COMPLETADA"
        echo "========================================"
        
        # Determinar qu√© valores usar
        if [ "${{ steps.check_cf.outputs.cf_exists }}" = "true" ]; then
          CF_ID="${{ steps.check_cf.outputs.distribution_id }}"
          CF_DOMAIN="${{ steps.check_cf.outputs.distribution_domain }}"
          echo "‚úÖ Usando CloudFront EXISTENTE"
        else
          CF_ID="${{ steps.create_cf.outputs.distribution_id }}"
          CF_DOMAIN="${{ steps.create_cf.outputs.distribution_domain }}"
          echo "‚úÖ NUEVO CloudFront CREADO"
        fi
        
        echo ""
        echo "üìã INFORMACI√ìN IMPORTANTE:"
        echo "   CloudFront ID: $CF_ID"
        echo ""
        echo "üîó URLs COMPARATIVAS:"
        echo ""
        echo "   ‚ùå SIN HTTPS (Not Secure):"
        echo "      http://${{ env.S3_BUCKET }}.s3-website-us-east-1.amazonaws.com"
        echo ""
        echo "   ‚úÖ CON HTTPS (Secure - USA ESTA):"
        echo "      üîí https://$CF_DOMAIN"
        echo ""
        echo "‚è±Ô∏è  TIEMPOS:"
        if [ "${{ steps.check_cf.outputs.cf_exists }}" = "true" ]; then
          echo "   ‚úì Listo para usar inmediatamente"
        else
          echo "   ‚ö†Ô∏è  Nueva distribuci√≥n - Espera 15-30 minutos"
        fi
        
        echo ""
        echo "üîß PASOS SIGUIENTES:"
        echo "   1. Copia esta URL: https://$CF_DOMAIN"
        echo "   2. Ejecuta el workflow 'Deploy to S3'"
        echo "   3. Abre la URL en el navegador"
        echo "   4. Deber√≠as ver el candado verde üîí"
        echo ""
        echo "‚ö†Ô∏è  NOTA: CloudFront SIEMPRE usar√° HTTPS"
        echo "         El 'Not Secure' desaparecer√°"
        echo "========================================"